#include "primary_generator.hh"

#include "G4ParticleTable.hh"
#include "G4ParticleDefinition.hh"
#include "G4SystemOfUnits.hh"
#include "Randomize.hh"
#include "G4MuonMinus.hh"
#include "G4RunManager.hh"
#include "event_action.hh"
#include <vector>
#include <cmath>

PrimaryGenerator::PrimaryGenerator()
: G4VUserPrimaryGeneratorAction()
{
    fParticleGun = new G4ParticleGun(1);
}

PrimaryGenerator::~PrimaryGenerator()
{
    delete fParticleGun;
}

void PrimaryGenerator::GeneratePrimaries(G4Event* event)
{
    auto* muon = G4MuonMinus::Definition();
    fParticleGun->SetParticleDefinition(muon);
    
    // ====== COSMIC RAY ENERGY SPECTRUM (Î±Ï€ÏŒ Ï„Î¿Î½ Ï€Î¯Î½Î±ÎºÎ¬ ÏƒÎ¿Ï…) ======
    
    // Energy bin edges ÏƒÎµ GeV: [0, 0.5, 1, 5, 10, 50, 200]
    static const std::vector<G4double> Eedges = {
        0.0*GeV, 0.5*GeV, 1.0*GeV, 5.0*GeV, 10.0*GeV, 50.0*GeV, 200.0*GeV
    };
    
    // Î•Ï€Î¹Î»Î¿Î³Î® Î¼ÎµÏ„Î±Î¾Ï "flux" (Table 7) Î® "count" (Table 8)
    const G4String mode = "flux"; // Î‘Î»Î»Î¬Î¾Îµ ÏƒÎµ "count" Î±Î½ Î¸Î­Î»ÎµÎ¹Ï‚ Table 8
    
    std::vector<G4double> weights;
    if (mode == "flux") {
        // Muon flux Î±Î½Î¬ bin Î±Ï€ÏŒ Table 7: [0-0.5, 0.5-1, 1-5, 5-10, 10-50, >50]
        weights = {20.9, 23.7, 94.2, 32.1, 25.3, 2.26};
    } else {
        // Expected counts Î³Î¹Î± 3 Ï‡ÏÏŒÎ½Î¹Î± Î±Ï€ÏŒ Table 8: Î¯Î´Î¹Î± bins
        weights = {1.98e9, 2.24e9, 8.91e9, 3.03e9, 2.39e9, 2.14e8};
    }
    
    // Î”Î·Î¼Î¹Î¿Ï…ÏÎ³Î¯Î± Cumulative Distribution Function (CDF)
    std::vector<G4double> cdf(weights.size(), 0.0);
    G4double sumw = 0.0;
    for (auto w : weights) sumw += w;
    
    G4double acc = 0.0;
    for (size_t i = 0; i < weights.size(); ++i) {
        acc += weights[i] / sumw;
        cdf[i] = acc;
    }
    
    // Î•Ï€Î¹Î»Î¿Î³Î® energy bin
    G4double u = G4UniformRand();
    size_t ibin = 0;
    while (ibin < cdf.size() && u > cdf[ibin]) ++ibin;
    if (ibin >= weights.size()) ibin = weights.size() - 1;
    
    // Î”ÎµÎ¹Î³Î¼Î±Ï„Î¿Î»Î·ÏˆÎ¯Î± ÎµÎ½Î­ÏÎ³ÎµÎ¹Î±Ï‚ Î¼Î­ÏƒÎ± ÏƒÏ„Î¿ ÎµÏ€Î¹Î»ÎµÎ³Î¼Î­Î½Î¿ bin
    G4double Emin = Eedges[ibin];
    G4double Emax = Eedges[ibin + 1];
    
    G4double energy = 0.0;
    
    // Î“Î¹Î± Ï„Î¿ Ï„ÎµÎ»ÎµÏ…Ï„Î±Î¯Î¿ bin (>50 GeV), Ï‡ÏÎ®ÏƒÎ· ÎµÎºÎ¸ÎµÏ„Î¹ÎºÎ®Ï‚ ÎºÎ±Ï„Î±Î½Î¿Î¼Î®Ï‚
    if (ibin == weights.size() - 1) {
        // Î•ÎºÎ¸ÎµÏ„Î¹ÎºÎ® Î¼Îµ ÎºÎ»Î¯Î¼Î±ÎºÎ± 20 GeV, Ï€ÎµÏÎ¹ÎºÎ¿Î¼Î¼Î­Î½Î· ÏƒÏ„Î± 200 GeV
        const G4double E0 = 20.0*GeV;
        G4double u2 = G4UniformRand();
        
        // Î‘Î½Ï„Î¯ÏƒÏ„ÏÎ¿Ï†Î· CDF ÎµÎºÎ¸ÎµÏ„Î¹ÎºÎ®Ï‚ ÎºÎ±Ï„Î±Î½Î¿Î¼Î®Ï‚ ÏƒÏ„Î¿ [Emin, Emax]
        G4double A = std::exp(-Emin/E0) - std::exp(-Emax/E0);
        energy = -E0 * std::log(std::exp(-Emin/E0) - u2*A);
    } else {
        // ÎŸÎ¼Î¿Î¹ÏŒÎ¼Î¿ÏÏ†Î· ÎºÎ±Ï„Î±Î½Î¿Î¼Î® Î¼Î­ÏƒÎ± ÏƒÏ„Î¿ bin
        energy = Emin + (Emax - Emin) * G4UniformRand();
    }
    
    fParticleGun->SetParticleEnergy(energy);
    
    // ====== Î”Î•Î£ÎœÎ— GEOMETRY (ÏŒÏ€Ï‰Ï‚ ÏƒÏ„Î¿Î½ Î±ÏÏ‡Î¹ÎºÏŒ ÏƒÎ¿Ï… ÎºÏÎ´Î¹ÎºÎ±) ======
    
    // Î”Î•Î£ÎœÎ—: ÎšÎ¬Î¸ÎµÏ„Î· ÎºÎ±Ï„ÎµÏÎ¸Ï…Î½ÏƒÎ· (Î±Ï€ÏŒ Ï€Î¬Î½Ï‰ Ï€ÏÎ¿Ï‚ Ï„Î± ÎºÎ¬Ï„Ï‰)
    // ÎœÎ¹ÎºÏÎ® Ï„Ï…Ï‡Î±Î¯Î± Î±Ï€ÏŒÎºÎ»Î¹ÏƒÎ· Î³Î¹Î± Ï€Î¹Î¿ ÏÎµÎ±Î»Î¹ÏƒÏ„Î¹ÎºÎ® Î´Î­ÏƒÎ¼Î·
    G4double beam_divergence = 2.0*deg;  // Â±2Â° Î±Ï€ÏŒÎºÎ»Î¹ÏƒÎ·
    G4double theta = G4UniformRand() * beam_divergence - beam_divergence/2.0;
    G4double phi = G4UniformRand() * 360*deg;
    
    // ÎšÎ±Ï„ÎµÏÎ¸Ï…Î½ÏƒÎ·: ÎºÏ…ÏÎ¯Ï‰Ï‚ Ï€ÏÎ¿Ï‚ -Y (Î±Ï€ÏŒ Ï€Î¬Î½Ï‰ Ï€ÏÎ¿Ï‚ ÎºÎ¬Ï„Ï‰)
    fParticleGun->SetParticleMomentumDirection({
        std::sin(theta)*std::cos(phi),
        -std::cos(theta),  // ÎšÏ…ÏÎ¯Ï‰Ï‚ Ï€ÏÎ¿Ï‚ -Y (ÎºÎ¬Ï„Ï‰)
        std::sin(theta)*std::sin(phi)
    });
    
    // Î”Î•Î£ÎœÎ—: ÎœÎ¹ÎºÏÎ® Ï€ÎµÏÎ¹Î¿Ï‡Î® Ï€Î¬Î½Ï‰ Î±Ï€ÏŒ Ï„Î¿Î½ ÎºÏÏÏƒÏ„Î±Î»Î¿
    G4double beam_radius = 1.0*cm;  // Î‘ÎºÏ„Î¯Î½Î± Î´Î­ÏƒÎ¼Î·Ï‚ 1 cm
    G4double beam_x = G4UniformRand() * 2*beam_radius - beam_radius; // Â±1 cm
    G4double beam_z = +1*cm + (G4UniformRand() * 2*beam_radius - beam_radius); // Î³ÏÏÏ‰ Î±Ï€ÏŒ -12 cm
    G4double beam_y = 30*cm;  // 30 cm Ï€Î¬Î½Ï‰ Î±Ï€ÏŒ Ï„Î¿Î½ ÎºÏÏÏƒÏ„Î±Î»Î¿
    
    fParticleGun->SetParticlePosition({beam_x, beam_y, beam_z});
    
    fParticleGun->GeneratePrimaryVertex(event);
    
    // Record initial muon energy
    const auto* ue = G4RunManager::GetRunManager()->GetUserEventAction();
    auto* ea = const_cast<EventAction*>(
        dynamic_cast<const EventAction*>(ue));
    if (ea) {
        ea->SetInitialMuonEnergy(energy);
    }
    
    // Debug output Î³Î¹Î± Ï„Î± Ï€ÏÏÏ„Î± 5 events
    if (event->GetEventID() < 5) {
        G4cout << "ğŸŒŸ Event " << event->GetEventID() 
               << ": Muon Energy = " << energy/GeV << " GeV"
               << " (bin " << ibin << ")" << G4endl;
    }
}
